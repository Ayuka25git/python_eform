# 生産現場向け・可変型入力システム 要件定義書

## 1. プロジェクト概要
### 1.1 目的
生産現場における日報・検査記録のデジタル化を行う。
製品や工程によって管理項目が頻繁に変わるため、**プログラミング不要（ノーコード）で入力項目を増減・設定できるシステム**を構築する。

### 1.2 ターゲットユーザー
* **管理者:** データベース設定、入力フォームの設計を行う（生産技術・管理職）。
* **作業者:** 日々の生産実績、検査数値を入力する（現場オペレーター）。

---

## 2. システム機能要件

### 2.1 データベース接続設定機能
接続先のデータベースを環境に応じて切り替え可能とする。
* **対応DB:** PostgreSQL, Microsoft SQL Server
* **設定項目:**
    * DB種別選択 (PostgreSQL / SQL Server)
    * ホスト名 / IPアドレス
    * ポート番号
    * ユーザー名
    * パスワード
    * データベース名
* **機能:**
    * 接続テスト機能（入力値で接続確認を行う）
    * 設定保存機能（次回起動時に設定を保持する）

### 2.2 入力フォーム定義機能（ノーコード設定）
現場管理者が、入力したい項目を表形式で自由に定義できる機能。
* **UI形式:** グリッド（表）形式のエディタ
* **設定パラメータ（1行につき1項目）:**
    1.  **表示順:** 画面上の並び順
    2.  **項目名:** ラベルとして表示（例：電圧、外観、寸法）
    3.  **データ型:** 以下のいずれかを選択
        * `文字列` (Text)
        * `数値` (Number / Float)
        * `日付` (Date)
    4.  **単位:** 任意入力（例：mm, kg, V）
    5.  **必須フラグ:** 入力必須か否か
* **保存:** 定義情報をデータベースのマスタテーブルへ保存する。

### 2.3 データ入力機能
作業者が使用するメイン画面。
* **フロー:**
    1.  **ヘッダー情報入力:**
        * 日付 (Date) - デフォルトは当日
        * 品種 (Product Name)
        * 製造ロット番号 (Lot No)
    2.  **詳細入力への遷移:**
        * ヘッダー入力後、フォーカス移動またはボタン押下で詳細入力エリアへ移動。
    3.  **詳細データ入力（動的生成エリア）:**
        * 「2.2」で定義された項目リストに基づき、入力フォームを動的に自動生成して表示する。
        * **数値型:** 数値以外の入力をエラーまたはブロック。
        * **日付型:** カレンダーピッカー等で選択可能にする。
    4.  **データ登録:**
        * ヘッダー情報と詳細情報を紐付けてデータベースへ保存する。

---

## 3. 非機能要件・技術スタック
* **開発言語:** Python 3.x
* **GUIフレームワーク:** Streamlit, Tkinter, または Flet (要検討)
* **ORマッパー:** SQLAlchemy (DB切り替えの抽象化のため必須)
* **DBドライバ:**
    * `psycopg2` (PostgreSQL用)
    * `pyodbc` (SQL Server用)

---

## 4. データベース設計指針 (Schema Concept)
動的な項目管理を実現するため、EAV (Entity-Attribute-Value) パターン、またはJSON型カラムの利用を想定する。

### 4.1 テーブル構成案

#### A. システム設定 (ローカルファイル管理想定)
* DB接続情報 (`config.json` 等)

#### B. フォーム定義マスタ (`m_form_def`)
管理者が設定した項目の定義を保持する。
| カラム名 | データ型 | 説明 |
| :--- | :--- | :--- |
| `id` | PK | 定義ID |
| `label_name` | String | 項目名 |
| `data_type` | String | 型区分 (str/num/date) |
| `unit` | String | 単位 |
| `is_required` | Boolean | 必須フラグ |
| `display_order` | Integer | 表示順 |

#### C. 実績ヘッダー (`t_production_header`)
入力の共通部分（いつ、何を、どのロットで）。
| カラム名 | データ型 | 説明 |
| :--- | :--- | :--- |
| `id` | PK | 実績ID |
| `entry_date` | Date | 日付 |
| `product_name` | String | 品種 |
| `lot_no` | String | Lot No |
| `created_at` | DateTime | 登録日時 |

#### D. 実績明細 (`t_production_detail`)
動的項目の値を保存する。
| カラム名 | データ型 | 説明 |
| :--- | :--- | :--- |
| `id` | PK | 明細ID |
| `header_id` | FK | ヘッダーID |
| `def_id` | FK | 定義ID (`m_form_def.id`) |
| `value_str` | String | 入力値 (全て文字列として保存しアプリ側でキャスト) |